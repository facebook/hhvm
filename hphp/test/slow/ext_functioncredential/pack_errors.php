<?hh

class ExistingClass {
  public static function existingStaticMethod(): void {}
}

// Note: these were generated by hacking the extension to do max int validity
// then temporarily making valid class/method names and then running function
// credential in test mode to get a valid mac on all zeros key with permanent validity
const string NON_EXISTENT_CLASS = '{"valid_until":9223372036854775807,"class_name":"NonExistentClass","function_name":"nonExistentFunction"}:36a9682c40b4d4018708043fb1ffcc49717ec6240efa9a56b227baabb57a3952';
const string NON_EXISTENT_METHOD = '{"valid_until":9223372036854775807,"function_name":"nonExistentFunction","class_name":"ExistingClass"}:f299fa558dbcf23f3b26886547ac83b4c9b1f6f7746c28213e9830af312da7db';
const string NON_EXISTENT_FREE_FUNCTION = '{"valid_until":9223372036854775807,"class_name":null,"function_name":"not_existing_free_function"}:73d74c292be25492d2b54c5015ba8d60aa613847761873f4ecec453fed8c1d61';
const string EXPIRED_CREDENTIAL = '{"valid_until":1769368031,"function_name":"existingStaticMethod","class_name":"ExistingClass"}:ce874d369e260c8728637dd1d0a3e7232bfcf34d5b6ee84dc87723d82ded0662';
const string INVALID_AUTH_TAG = '{"valid_until":9223372036854775807,"class_name":"ExistingClass","function_name":"existingStaticMethod"}:36a9682c40b4d4018708043fb1ffcc49717ec6240efa9a56b227baabb57a3952';

<<__EntryPoint>>
function main(): void {
  // Test 1: Data too short (less than 65 chars: colon + 64 hex chars for auth tag)
  echo "Test 1: Data too short\n";
  try {
    FunctionCredential::unpack("short");
  } catch (InvalidArgumentException $e) {
    echo "Caught exception: " . $e->getMessage() . "\n";
  }
  echo "\n";

  // Test 2: Invalid auth tag (valid length but verification fails)
  echo "Test 2: Invalid auth tag\n";
  try {
    // Create data with valid format but wrong signature
    // Format: "json:hex_tag" where hex_tag is 64 chars
    $fakeJson = '{"class_name":null,"function_name":"fake","valid_until":9999999999}';
    $garbage = $fakeJson . ":" . str_repeat("00", 32);
    FunctionCredential::unpack($garbage);
  } catch (InvalidArgumentException $e) {
    echo "Caught exception: " . $e->getMessage() . "\n";
  }
  echo "\n";

  // Test 3: Empty string
  echo "Test 3: Empty string\n";
  try {
    FunctionCredential::unpack("");
  } catch (InvalidArgumentException $e) {
    echo "Caught exception: " . $e->getMessage() . "\n";
  }
  echo "\n";

  // Test 4: Invalid hex in auth tag
  echo "Test 4: Invalid hex in auth tag\n";
  try {
    // Valid JSON format but invalid hex chars (contains 'Z')
    $fakeJson = '{"class_name":null,"function_name":"test","valid_until":9999999999}';
    $invalidHex = $fakeJson . ":" . str_repeat("ZZ", 32);
    FunctionCredential::unpack($invalidHex);
  } catch (InvalidArgumentException $e) {
    echo "Caught exception: " . $e->getMessage() . "\n";
  }
  echo "\n";

  // Test 5: Missing colon delimiter before auth tag
  echo "Test 5: Missing colon delimiter\n";
  try {
    // 65 chars but no colon at expected position
    $noColon = "X" . str_repeat("00", 32);
    FunctionCredential::unpack($noColon);
  } catch (InvalidArgumentException $e) {
    echo "Caught exception: " . $e->getMessage() . "\n";
  }
  echo "\n";

  echo "Test 6: Non-existent class\n";
  try {
    FunctionCredential::unpack(NON_EXISTENT_CLASS);
  } catch (InvalidArgumentException $e) {
    echo "Caught exception: " . $e->getMessage() . "\n";
  }
  echo "\n";

  echo "Test 7: Non-existent method\n";
  try {
    FunctionCredential::unpack(NON_EXISTENT_METHOD);
  } catch (InvalidArgumentException $e) {
    echo "Caught exception: " . $e->getMessage() . "\n";
  }
  echo "\n";

  echo "Test 8: Non-existent free function\n";
  try {
    FunctionCredential::unpack(NON_EXISTENT_FREE_FUNCTION);
  } catch (InvalidArgumentException $e) {
    echo "Caught exception: " . $e->getMessage() . "\n";
  }
  echo "\n";

  echo "Test 9: Expired credential\n";
  try {
    FunctionCredential::unpack(EXPIRED_CREDENTIAL);
  } catch (InvalidArgumentException $e) {
    echo "Caught exception: " . $e->getMessage() . "\n";
  }
  echo "\n";

  echo "Test 10: Failed Verification\n";
  try {
    FunctionCredential::unpack(INVALID_AUTH_TAG);
  } catch (InvalidArgumentException $e) {
    echo "Caught exception: " . $e->getMessage() . "\n";
  }
  echo "\n";
}
