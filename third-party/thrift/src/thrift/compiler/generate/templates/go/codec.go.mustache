{{!
  Copyright (c) Meta Platforms, Inc. and affiliates.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

}}{{!

    NOTE:
    Unfortunately map literals cannot be used to store metadata, due to a bug
    in the Go compiler: https://github.com/golang/go/issues/33437
    The bug results in a "NewBulk too big" compilation error for some very large schemas.
    The workaround is to create slice literals (one with keys, one with values),
    create an empty map during runtime and populate that map from the two slices.

}}
{{#import "common/constants" as constants}}
{{#import "codec/codec" as codec}}
{{#import "spec/spec" as spec}}
{{> common/auto_generated_go}}

package {{root_program.go_pkg_name}}

import (
    {{#each root_program.thrift_imports as |program|}}
    {{program.go_package_alias}} "{{program.go_import_path}}"
    {{/each}}
    thrift "{{constants.thrift_lib_import}}"
)

// (needed to ensure safety because of naive import list construction)
{{> common/unused_imports_protection}}
var _ = thrift.VOID

// Premade codec specs
var (
    {{#each root_program.thrift_metadata_types as |type|}}
    {{type.codec_type_spec_name}} = &thrift.TypeSpec{
        FullName: "{{type.full_name}}",
        {{#partial spec.codec_type_spec_setter type=type}}:
            {{#partial spec.codec_type_spec_instance type=type}}
    }
    {{/each}}
)

// Premade struct specs
var (
    {{#each root_program.structured_definitions as |s|}}
    {{s.struct_spec_name}} =
        {{#partial spec.codec_struct_spec struct=s}}
    {{/each}}
    {{#each root_program.req_resp_structs as |s|}}
    {{s.struct_spec_name}} =
        {{#partial spec.codec_struct_spec struct=s}}
    {{/each}}
)

var premadeCodecSpecsMap = func() map[string]*thrift.TypeSpec {
    fbthriftTypeSpecsMap := make(map[string]*thrift.TypeSpec)
    {{#each root_program.thrift_metadata_types as |type|}}
    {{#if type.named?}}
    fbthriftTypeSpecsMap[{{type.codec_type_spec_name}}.FullName] = {{type.codec_type_spec_name}}
    {{/if type.named?}}
    {{/each}}
    return fbthriftTypeSpecsMap
}()

// GetMetadataThriftType (INTERNAL USE ONLY).
// Returns metadata TypeSpec for a given full type name.
func GetCodecTypeSpec(fullName string) *thrift.TypeSpec {
    return premadeCodecSpecsMap[fullName]
}
