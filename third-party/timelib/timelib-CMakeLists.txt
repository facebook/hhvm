cmake_minimum_required(VERSION 2.6)
project(timelib C)

# adapted from timelibs FLAGS removing usan, asan, and development flags like
# -Werror
set(CMAKE_C_FLAGS "-DHAVE_STDINT_H -DHAVE_GETTIMEOFDAY -DHAVE_UNISTD_H -DHAVE_DIRENT_H")
include_directories("${CMAKE_CURRENT_SOURCE_DIR}")

find_program(RE2C NAMES re2c REQUIRED)

add_custom_command(
  OUTPUT parse_date.c
  MAIN_DEPENDENCY parse_date.re
  COMMAND ${RE2C} ${CMAKE_CURRENT_SOURCE_DIR}/parse_date.re -o ${CMAKE_CURRENT_BINARY_DIR}/parse_date.c
)
add_custom_command(
  OUTPUT parse_iso_intervals.c
  MAIN_DEPENDENCY parse_iso_intervals.re
  COMMAND ${RE2C} ${CMAKE_CURRENT_SOURCE_DIR}/parse_date.re -o ${CMAKE_CURRENT_BINARY_DIR}/parse_iso_intervals.c
)

file(GLOB files *.c)
file(GLOB hfiles *.h)
add_library(timelib STATIC ${files} ${hfiles} parse_date.c parse_iso_intervals.c)
install(FILES ${hfiles} DESTINATION "${CMAKE_INSTALL_PREFIX}/${CMAKE_INSTALL_INCLUDEDIR}")
install(TARGETS timelib ARCHIVE DESTINATION "${CMAKE_INSTALL_PREFIX}/${CMAKE_INSTALL_LIBDIR}")
