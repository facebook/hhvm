{{!

  Copyright (c) Meta Platforms, Inc. and affiliates.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

}}
{{#import "common/constants" as constants}}
{{#import "common/type" as types}}

{{! New*() }}
{{#let export partial new |struct|}}
func {{struct.go_qualified_new_func}}() *{{struct.go_name}} {
    return (&{{struct.go_name}}{}).setDefaults()
}
{{/let partial}}

{{! Error() }}
{{#let export partial error |struct|}}
func (x *{{struct.go_name}}) Error() string {
    return x.String()
}
{{/let partial}}

{{! Exception() }}
{{#let export partial exception |struct|}}
func (x *{{struct.go_name}}) Exception() thrift.WritableException {
    {{#each struct.fields_sorted as |field|}}
    {{^field.retval?}}
    if x.{{field.go_name}} != nil {
        return x.{{field.go_name}}
    }
    {{/field.retval?}}
    {{/each}}
    return nil
}
{{/let partial}}

{{! getStructSpec() }}
{{#let export partial get_spec |struct|}}
func (x *{{struct.go_name}}) getStructSpec() *thrift.StructSpec {
    return {{struct.struct_spec_name}}
}
{{/let partial}}

{{! GetThriftStructMetadata() }}
{{#let export partial get_thrift_metadata |struct|}}
func (x *{{struct.go_name}}) GetThriftStructMetadata() *{{struct.program.metadata_qualifier}}{{#if struct.exception?}}ThriftException{{#else}}ThriftStruct{{/if}} {
    return {{struct.struct_metadata_name}}
}
{{/let partial}}

{{! Read() (v2) }}
{{#let export partial read_v2 |struct|}}
func (x *{{struct.go_name}}) Read(p thrift.Decoder) error {
    return thrift.ReadStructSpec(p, x, x.getStructSpec())
}
{{/let partial}}

{{! String() }}
{{#let export partial string |struct|}}
func (x *{{struct.go_name}}) String() string {
    return thrift.StructToString(reflect.ValueOf(x))
}
{{/let partial}}

{{! TypeName() }}
{{#let export partial type_name |struct|}}
func (x *{{struct.go_name}}) TypeName() string {
    return "{{struct.name}}"
}
{{/let partial}}

{{! Write() (v2) }}
{{#let export partial write_v2 |struct|}}
func (x *{{struct.go_name}}) Write(p thrift.Encoder) error {
    {{#struct.union?}}
    if countSet := x.countSetFields(); countSet > 1 {
        return fmt.Errorf("{{struct.go_name}} write union: no more than one field must be set (%d set).", countSet)
    }
    {{/struct.union?}}
    return thrift.WriteStructSpec(p, x, x.getStructSpec())
}
{{/let partial}}

{{! setDefaults() }}
{{#let export partial set_defaults |struct| captures |constants types|}}
func (x *{{struct.go_name}}) setDefaults() *{{struct.go_name}} {
    return x{{#if (not struct.union?)}}{{#each struct.fields_sorted as |field|}}{{#let type = field.type}}{{!

        // Fields with given default values.
        }}{{#if (object.notnull? field.default_value)}}.
        {{field.go_setter_name}}{{#if root_program.compat_setters?}}NonCompat{{/if}}({{!
          }}{{#if (not type.primitive?)}}
            {{#partial constants.const_value value=field.default_value root_const=null}},
        {{#else}}{{!
            }}{{#partial constants.const_value value=field.default_value root_const=null}}{{!
        }}{{/if (not type.primitive?)}}{{!
        }}){{#else}}{{!

        // Non-optional fields without given default values.
        }}{{#if (not field.optional?)}}.
        {{field.go_setter_name}}{{#if root_program.compat_setters?}}NonCompat{{/if}}({{!
            }}{{#partial types.natural_default_value type=type}}{{!
        }}){{/if (not field.optional?)}}{{!
        }}{{/if (object.notnull? field.default_value)}}{{!
    }}{{/each}}{{/if (not struct.union?)}}
}
{{/let partial}}
